<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Preschool English Evaluation</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f5f7fb 0%, #e4edf5 100%);
      color: #333;
      line-height: 1.6;
      padding: 20px;
      min-height: 100vh;
    }
    
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
      overflow: hidden;
    }
    
    header {
      background: linear-gradient(135deg, #2a53c1 0%, #1e3f9b 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }
    
    h1 {
      font-size: 32px;
      margin-bottom: 8px;
    }
    
    .subtitle {
      font-size: 16px;
      opacity: 0.9;
    }
    
    .form-container {
      padding: 30px;
    }
    
    .student-info {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 30px;
    }
    
    @media (max-width: 600px) {
      .student-info {
        grid-template-columns: 1fr;
      }
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: #2a53c1;
    }
    
    input, select, textarea {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #d1d9e6;
      border-radius: 8px;
      font-size: 16px;
      transition: all 0.3s;
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #2a53c1;
      box-shadow: 0 0 0 3px rgba(42, 83, 193, 0.1);
    }
    
    textarea {
      min-height: 120px;
      resize: vertical;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    .category {
      margin-bottom: 20px;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      overflow: hidden;
    }
    
    .category-header {
      background: #f8fafc;
      padding: 18px 20px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background 0.3s;
    }
    
    .category-header:hover {
      background: #f1f5f9;
    }
    
    .category-title {
      font-size: 18px;
      font-weight: 600;
      color: #2a53c1;
    }
    
    .category-icon {
      transition: transform 0.3s;
    }
    
    .category.active .category-icon {
      transform: rotate(180deg);
    }
    
    .category-content {
      padding: 0;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out, padding 0.3s;
    }
    
    .category.active .category-content {
      padding: 20px;
      max-height: 1000px;
    }
    
    .subcategory {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #f1f5f9;
    }
    
    .subcategory:last-child {
      border-bottom: none;
    }
    
    .subcategory-name {
      flex: 1;
    }
    
    .rating-options {
      display: flex;
      gap: 10px;
    }
    
    .rating-option {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .rating-label {
      font-size: 14px;
      white-space: nowrap;
    }
    
    .comments-section {
      margin-top: 30px;
      padding: 25px;
      background: #f8fafc;
      border-radius: 12px;
      border: 1px solid #e2e8f0;
    }
    
    .comments-title {
      font-size: 20px;
      color: #2a53c1;
      margin-bottom: 15px;
      font-weight: 600;
    }
    
    .actions {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: 40px;
      flex-wrap: wrap;
    }
    
    button {
      padding: 14px 28px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn-primary {
      background: #2a53c1;
      color: white;
    }
    
    .btn-primary:hover {
      background: #1e3f9b;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(30, 63, 155, 0.3);
    }
    
    .btn-secondary {
      background: #f1f5f9;
      color: #475569;
      border: 1px solid #d1d9e6;
    }
    
    .btn-secondary:hover {
      background: #e2e8f0;
      transform: translateY(-2px);
    }
    
    .preview-container {
      margin-top: 40px;
      border-top: 1px solid #e2e8f0;
      padding-top: 30px;
    }
    
    .preview-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .preview-title {
      font-size: 20px;
      color: #2a53c1;
    }
    
    .preview-actions {
      display: flex;
      gap: 10px;
    }
    
    #emailPreview {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 20px;
      white-space: pre-wrap;
      font-family: monospace;
      max-height: 400px;
      overflow-y: auto;
      line-height: 1.5;
    }
    
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #10b981;
      color: white;
      padding: 15px 25px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      display: none;
      z-index: 1000;
    }
    
    footer {
      text-align: center;
      margin-top: 30px;
      padding: 20px;
      color: #64748b;
      font-size: 14px;
      border-top: 1px solid #e2e8f0;
    }
    
    .rating-legend {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 20px 0;
      flex-wrap: wrap;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 14px;
    }
    
    .legend-color {
      width: 16px;
      height: 16px;
      border-radius: 4px;
    }
    
    .needs-attention {
      background: #ef4444;
    }
    
    .basic-understanding {
      background: #f59e0b;
    }
    
    .mastered {
      background: #10b981;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Preschool English Evaluation</h1>
      <p class="subtitle">Cambridge-aligned proficiency evaluation with rating system</p>
    </header>
    
    <div class="form-container">
      <div class="student-info">
        <div class="form-group">
          <label for="studentNameSelect">Student Name</label>
          <select id="studentNameSelect">
            <option value="">-- Select a Student --</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="parentEmail">Parent Email</label>
          <input type="email" id="parentEmail" placeholder="Select a student to auto-fill">
        </div>
        
        <div class="form-group">
          <label for="teacherName">Teacher Name</label>
          <input type="text" id="teacherName" placeholder="e.g. Mr. Ian">
        </div>
        
        <div class="form-group">
          <label for="reportDate">Evaluation Date</label>
          <input type="date" id="reportDate">
        </div>
      </div>
      
      <div class="rating-legend">
        <div class="legend-item">
          <div class="legend-color needs-attention"></div>
          <span>Needs Attention</span>
        </div>
        <div class="legend-item">
          <div class="legend-color basic-understanding"></div>
          <span>Basic Understanding</span>
        </div>
        <div class="legend-item">
          <div class="legend-color mastered"></div>
          <span>Mastered</span>
        </div>
      </div>
      
      <div id="categories"></div>
      
      <!-- Comments Section -->
      <div class="comments-section">
        <div class="comments-title">Teacher Comments</div>
        <div class="form-group">
          <label for="strengthsComments">Strengths & Achievements</label>
          <textarea id="strengthsComments" placeholder="Note the student's key strengths and notable achievements..."></textarea>
        </div>
        <div class="form-group">
          <label for="improvementComments">Areas for Improvement</label>
          <textarea id="improvementComments" placeholder="Suggest areas where the student could focus on improvement..."></textarea>
        </div>
        <div class="form-group">
          <label for="generalComments">General Comments & Recommendations</label>
          <textarea id="generalComments" placeholder="Additional comments, observations, or recommendations for parents..."></textarea>
        </div>
      </div>
      
      <div class="actions">
        <button id="previewBtn" class="btn-primary">
          <span>üìÑ</span> Preview Report
        </button>
        <button id="generateEmail" class="btn-primary">
          <span>‚úâÔ∏è</span> Generate Email
        </button>
        <button id="copyBtn" class="btn-secondary">
          <span>üìã</span> Copy to Clipboard
        </button>
      </div>
      
      <div class="preview-container">
        <div class="preview-header">
          <h3 class="preview-title">Email Preview</h3>
          <div class="preview-actions">
            <button id="downloadBtn" class="btn-secondary">
              <span>‚¨áÔ∏è</span> Download
            </button>
          </div>
        </div>
        <pre id="emailPreview">Complete the form and click "Preview Report" to generate the evaluation email.</pre>
      </div>
    </div>
    
    <footer>
      Evaluation Tool ¬© 2025 Mr Ian's Class Room | Based on Cambridge English framework
    </footer>
  </div>
  
  <div class="notification" id="notification"></div>

  <script>
    // Store student data received from the dashboard
    let studentData = [];

    // Evaluation data structure
    const evaluationData = [
      {
        title: 'Listening Comprehension',
        subs: [
          'Word recognition',
          'Instruction following',
          'Sound & rhythm awareness',
          'Story understanding',
          'Listening for specific information'
        ]
      },
      {
        title: 'Speaking & Pronunciation',
        subs: [
          'Vocabulary recall',
          'Sentence production',
          'Pronunciation clarity',
          'Interaction',
          'Fluency & confidence'
        ]
      },
      {
        title: 'Reading & Word Recognition',
        subs: [
          'Alphabet knowledge',
          'Phonics awareness',
          'Sight words',
          'Picture-word connection',
          'Simple sentence understanding'
        ]
      },
      {
        title: 'Writing & Spelling',
        subs: [
          'Pencil control',
          'Copying words',
          'Spelling awareness',
          'Sentence building',
          'Creativity (drawing + labels)'
        ]
      },
      {
        title: 'Communication & Language Use in Context',
        subs: [
          'Classroom interaction',
          'Expressing needs & feelings',
          'Question and answer',
          'Storytelling & play',
          'Cultural & social awareness'
        ]
      }
    ];

    // --- NEW: Listen for messages from the parent dashboard ---
    window.addEventListener('message', function(event) {
        // A security check to ensure the message is from a trusted source could be added here
        // for example: if (event.origin !== 'https://your-dashboard-url.com') return;

        if (event.data && event.data.type === 'UPDATE_STUDENT_DATA') {
            studentData = event.data.students; // Save the student list
            populateStudentDropdown(studentData);
        }
    });

    // --- NEW: Function to populate the student dropdown ---
    function populateStudentDropdown(students) {
        const select = document.getElementById('studentNameSelect');
        select.innerHTML = '<option value="">-- Select a Student --</option>'; // Clear old options and add default

        students.forEach(student => {
            const option = document.createElement('option');
            option.value = student.id; // Use the unique ID as the value
            option.textContent = `${student.englishName} (${student.vietnameseName})`;
            select.appendChild(option);
        });
    }

    // --- NEW: Add event listener to the dropdown to auto-fill fields ---
    document.getElementById('studentNameSelect').addEventListener('change', function() {
        const selectedStudentId = this.value;
        const parentEmailInput = document.getElementById('parentEmail');

        if (selectedStudentId) {
            // Find the selected student in our stored data
            const selectedStudent = studentData.find(s => s.id === selectedStudentId);
            if (selectedStudent) {
                parentEmailInput.value = selectedStudent.parentEmail;
            }
        } else {
            parentEmailInput.value = ''; // Clear email if "Select a Student" is chosen
        }
    });


    // Set current date as default
    document.getElementById('reportDate').valueAsDate = new Date();

    // Generate the evaluation form
    const categoriesContainer = document.getElementById('categories');
    
    evaluationData.forEach((category, categoryIndex) => {
      const categoryElement = document.createElement('div');
      categoryElement.className = 'category';
      if (categoryIndex === 0) categoryElement.classList.add('active');
      
      categoryElement.innerHTML = `
        <div class="category-header">
          <div class="category-title">${category.title}</div>
          <div class="category-icon">‚ñº</div>
        </div>
        <div class="category-content">
          ${category.subs.map((sub, subIndex) => `
            <div class="subcategory">
              <div class="subcategory-name">${sub}</div>
              <div class="rating-options">
                <div class="rating-option">
                  <input type="radio" id="cat${categoryIndex}_sub${subIndex}_1" name="cat${categoryIndex}_sub${subIndex}" value="1">
                  <label class="rating-label" for="cat${categoryIndex}_sub${subIndex}_1">Needs Attention</label>
                </div>
                <div class="rating-option">
                  <input type="radio" id="cat${categoryIndex}_sub${subIndex}_2" name="cat${categoryIndex}_sub${subIndex}" value="2">
                  <label class="rating-label" for="cat${categoryIndex}_sub${subIndex}_2">Basic</label>
                </div>
                <div class="rating-option">
                  <input type="radio" id="cat${categoryIndex}_sub${subIndex}_3" name="cat${categoryIndex}_sub${subIndex}" value="3">
                  <label class="rating-label" for="cat${categoryIndex}_sub${subIndex}_3">Mastered</label>
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      `;
      
      categoriesContainer.appendChild(categoryElement);
      
      // Add click event to toggle category
      const header = categoryElement.querySelector('.category-header');
      header.addEventListener('click', () => {
        categoryElement.classList.toggle('active');
      });
    });

    // --- MODIFIED: Build the evaluation report ---
    function buildReport() {
      const studentSelect = document.getElementById('studentNameSelect');
      let studentName = 'Student'; // Default value
      if (studentSelect.value) { // Check if a real student is selected
          studentName = studentSelect.options[studentSelect.selectedIndex].text;
      }

      const teacherName = document.getElementById('teacherName').value || 'Teacher';
      const reportDate = document.getElementById('reportDate').value || new Date().toLocaleDateString();
      
      let reportLines = [
        `English Progress Report for ${studentName}`,
        `Evaluation Date: ${reportDate}`,
        `Teacher: ${teacherName}`,
        '',
        'EVALUATION RESULTS:',
        ''
      ];
      
      // Process each category
      evaluationData.forEach((category, categoryIndex) => {
        const categoryRatings = [];
        
        // Check each subcategory in this category
        category.subs.forEach((sub, subIndex) => {
          const radioName = `cat${categoryIndex}_sub${subIndex}`;
          const selectedRadio = document.querySelector(`input[name="${radioName}"]:checked`);
          
          if (selectedRadio) {
            const ratingValue = parseInt(selectedRadio.value);
            let ratingText;
            
            switch(ratingValue) {
              case 1:
                ratingText = 'Needs Attention';
                break;
              case 2:
                ratingText = 'Basic Understanding';
                break;
              case 3:
                ratingText = 'Mastered';
                break;
              default:
                ratingText = 'Not Rated';
            }
            
            categoryRatings.push(`  ‚Ä¢ ${sub}: ${ratingText}`);
          }
        });
        
        // Only add category to report if it has ratings
        if (categoryRatings.length > 0) {
          reportLines.push(`${category.title}:`);
          reportLines.push(...categoryRatings);
          reportLines.push('');
        }
      });
      
      // Add comments section if any comments are provided
      const strengthsComments = document.getElementById('strengthsComments').value.trim();
      const improvementComments = document.getElementById('improvementComments').value.trim();
      const generalComments = document.getElementById('generalComments').value.trim();
      
      if (strengthsComments || improvementComments || generalComments) {
        reportLines.push('TEACHER COMMENTS:');
        reportLines.push('');
        
        if (strengthsComments) {
          reportLines.push('Strengths & Achievements:');
          reportLines.push(`  ${strengthsComments}`);
          reportLines.push('');
        }
        
        if (improvementComments) {
          reportLines.push('Areas for Improvement:');
          reportLines.push(`  ${improvementComments}`);
          reportLines.push('');
        }
        
        if (generalComments) {
          reportLines.push('General Comments & Recommendations:');
          reportLines.push(`  ${generalComments}`);
          reportLines.push('');
        }
      }
      
      // Add summary and closing
      reportLines.push(
        'SUMMARY:',
        '',
        'This evaluation provides a snapshot of your child\'s current English proficiency across key developmental areas.',
        'We encourage continued practice and engagement with English language activities at home.',
        '',
        'Please feel free to contact me if you have any questions about this evaluation or your child\'s progress.',
        '',
        'Best regards,',
        teacherName,
        'Mr Ian\'s Class Room'
      );
      
      return {
        subject: `English Progress Report for ${studentName} - ${reportDate}`,
        body: reportLines.join('\n')
      };
    }

    // Update the preview
    function updatePreview() {
      const report = buildReport();
      document.getElementById('emailPreview').textContent = `Subject: ${report.subject}\n\n${report.body}`;
    }

    // Show notification
    function showNotification(message, isError = false) {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.style.background = isError ? '#ef4444' : '#10b981';
      notification.style.display = 'block';
      
      setTimeout(() => {
        notification.style.display = 'none';
      }, 3000);
    }

    // Event listeners
    document.getElementById('previewBtn').addEventListener('click', updatePreview);
    
    document.getElementById('generateEmail').addEventListener('click', () => {
      updatePreview();
      const report = buildReport();
      const parentEmail = document.getElementById('parentEmail').value.trim();
      
      if (!parentEmail) {
        showNotification('Please enter a parent email address', true);
        return;
      }
      
      if (!document.querySelector('input[type="radio"]:checked')) {
        showNotification('Please rate at least one skill area', true);
        return;
      }
      
      const mailtoLink = `mailto:${encodeURIComponent(parentEmail)}?subject=${encodeURIComponent(report.subject)}&body=${encodeURIComponent(report.body)}`;
      window.location.href = mailtoLink;
    });
    
    document.getElementById('copyBtn').addEventListener('click', () => {
      updatePreview();
      const previewText = document.getElementById('emailPreview').textContent;
      
      navigator.clipboard.writeText(previewText)
        .then(() => showNotification('Report copied to clipboard!'))
        .catch(() => showNotification('Failed to copy to clipboard', true));
    });
    
    document.getElementById('downloadBtn').addEventListener('click', () => {
      updatePreview();
      const text = document.getElementById('emailPreview').textContent;
      const blob = new Blob([text], {type: 'text/plain'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;

      const studentSelect = document.getElementById('studentNameSelect');
      let fileName = 'English_Evaluation_Student';
      if(studentSelect.value) {
        fileName = `English_Evaluation_${studentSelect.options[studentSelect.selectedIndex].text.split(' ')[0]}`;
      }
      a.download = `${fileName}.txt`;

      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      showNotification('Report downloaded successfully!');
    });
  </script>
</body>
</html>